document.addEventListener('DOMContentLoaded', () => {lucide.createIcons();loadAllContent();setupScrollSpy();setupSmoothScrolling();setupHighlighter();});async function loadAllContent() {const contentContainer = document.getElementById('content-container');if (!contentContainer) return;try {const chapterFiles = ['content/chapter_1.html','content/chapter_2.html','content/chapter_4.html'];let fullContent = '';for (const file of chapterFiles) {const response = await fetch(file);if (!response.ok) {throw new Error(`Failed to load ${file}: ${response.statusText}`);}fullContent += await response.text();}contentContainer.innerHTML = fullContent;lucide.createIcons(); // Re-run lucide after adding new content} catch (error) {contentContainer.innerHTML = `<p class="text-red-500">Erro ao carregar o conteúdo da apostila. Tente recarregar a página.</p><p>${error.message}</p>`;console.error(error);}}function setupSmoothScrolling() {const navLinks = document.querySelectorAll('a.nav-link:not(.inactive)');navLinks.forEach(link => {link.addEventListener('click', function(e) {if (this.hash !== "") {e.preventDefault();const targetElement = document.querySelector(this.hash);if (targetElement) {targetElement.scrollIntoView({behavior: 'smooth'});}}});});}function setupScrollSpy() {const sections = document.querySelectorAll('section[id]');const navLinks = document.querySelectorAll('#navigation-menu .nav-link');const observer = new IntersectionObserver((entries) => {entries.forEach(entry => {if (entry.isIntersecting) {navLinks.forEach(link => {link.classList.remove('active');if (link.getAttribute('href').substring(1) === entry.target.id) {link.classList.add('active');}});}});}, { rootMargin: "-30% 0px -70% 0px", threshold: 0 });sections.forEach(section => {observer.observe(section);});const lastSection = sections[sections.length -1];if(lastSection) {const lastSectionObserver = new IntersectionObserver((entries) => {const [entry] = entries;if (entry.isIntersecting) {navLinks.forEach(link => {link.classList.remove('active');if (link.getAttribute('href').substring(1) === entry.target.id) {link.classList.add('active');}});}}, { threshold: 0.8 });lastSectionObserver.observe(lastSection);}}let highlightToolbar;let highlightButton;let currentSelectionRange = null;function setupHighlighter() {highlightToolbar = document.getElementById('highlight-toolbar');highlightButton = document.getElementById('highlight-button');const mainContent = document.querySelector('main .prose');if (!highlightToolbar || !highlightButton || !mainContent) {console.warn("Highlighter elements not found.");return;}lucide.createIcons({container: highlightToolbar});mainContent.addEventListener('mouseup', (e) => {const selection = window.getSelection();const selectedText = selection.toString().trim();if (selectedText.length > 0 && mainContent.contains(selection.anchorNode) && mainContent.contains(selection.focusNode)) {currentSelectionRange = selection.getRangeAt(0);showHighlightToolbar();} else {hideHighlightToolbar();}});document.addEventListener('mousedown', (e) => {if (highlightToolbar.classList.contains('visible') && !highlightToolbar.contains(e.target) && !mainContent.contains(e.target)) {hideHighlightToolbar();}});highlightButton.addEventListener('click', () => {if (currentSelectionRange) {applyHighlight(currentSelectionRange);hideHighlightToolbar();window.getSelection().removeAllRanges();}});function showHighlightToolbar() {if (!currentSelectionRange) return;const rect = currentSelectionRange.getBoundingClientRect();let top = rect.top + window.scrollY - highlightToolbar.offsetHeight - 10;let left = rect.left + window.scrollX + (rect.width / 2) - (highlightToolbar.offsetWidth / 2);if (left < window.scrollX + 10) {left = window.scrollX + 10;}if (left + highlightToolbar.offsetWidth > window.scrollX + window.innerWidth - 10) {left = window.scrollX + window.innerWidth - highlightToolbar.offsetWidth - 10;}if (top < window.scrollY + 10) {top = rect.bottom + window.scrollY + 10;}highlightToolbar.style.top = `${top}px`;highlightToolbar.style.left = `${left}px`;highlightToolbar.classList.remove('hidden');setTimeout(() => {highlightToolbar.classList.add('visible');}, 10);}function hideHighlightToolbar() {highlightToolbar.classList.remove('visible');setTimeout(() => {highlightToolbar.classList.add('hidden');}, 200);currentSelectionRange = null;}function applyHighlight(range) {if (!range) return;const span = document.createElement('span');span.classList.add('highlighted-text');try {const commonAncestor = range.commonAncestorContainer;const existingHighlights = commonAncestor.querySelectorAll('.highlighted-text');let shouldWrap = true;for (const existingHighlight of existingHighlights) {const existingRange = document.createRange();existingRange.selectNodeContents(existingHighlight);if (range.compareBoundaryPoints(Range.START_TO_START, existingRange) >= 0 &&range.compareBoundaryPoints(Range.END_TOEND, existingRange) <= 0) {shouldWrap = false;break;}}if (shouldWrap) {range.surroundContents(span);}} catch (e) {console.error("Error applying highlight:", e);}}}
